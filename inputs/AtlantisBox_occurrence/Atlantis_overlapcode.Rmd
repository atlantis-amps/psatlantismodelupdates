---
title: "Atlantis_overlap"
author: "L. E. Koehn"
date: "12/29/2021"
output:
  word_document: default
  html_document: default
---

READ ME: This document takes orca master data of killer whale sightings for the years 2011 - 2020 to match sightings of Southern Resident killer whales to Puget Sound Atlantis boxes. First, sightings are filtered to only sightings where there was confidence that the sighting was of Southern Resident killer whales (vs other killer whale populations). Specifically, data is filtered to sightings where the "likely pod" is either SRKW, SRs, J, K, or L; so excludes any sightings where the sighting could only be identified to the "orca" level (not more specific). Also excludes sightings that were specified as transients, Northern residents, "not orcas", or HBs (humpbacks). Data was then filtered to years 2011-2020. From there, I filtered down to unique day-quadrant sightings. Specifically, if there are any 2+ sightings with the same date and Whale Museum specified quadrant number, I only keep 1 sighting with that day-quadrant combo. This is to remove sightings from multiple sources that can inflate occurrence in an area. Note, this then means that there could be multiple sightings on the same day in the same Atlantis box, but they will all be in different Whale Museum quadrants. 

Note also that I filtered data down to only sightings with a whale museum identified quadrant number because these will occur in the Salish sea. Note that Whale Museum quadrant extend passed the Atlantis box domain (we do not have a shapefile of the quadrants but image is included with data). This may miss a few sightings if a quadrant was not specified by the Whale Museum but not a large amount. 

With the sightings data, I convert sightings to an sf object with latitude and longitude. I then use the CRS of the Atlantis polygons and project the SRKW sightings sf to the same CRS as the Atlantis polygons so that all are in the same sf space/same traget coordinate reference system (function st_transform). Then using st_intersection, this function finds the Atlantis polygons that each sighting falls into. 

The final output file has for all the day-quadrant unique SRKW sightings from 2011-2020, the date (including month, day, year) and the Atlantis polygon where the sighting fell. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rlang)
library("ggplot2")
theme_set(theme_bw())
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library(ggrepel)
library(here)
here() # will point to the directory you are working from 

world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)
usa <- subset(world, admin == "United States of America")

world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))

library(mapview)
library(tidyverse)
library(rgdal)
library(formattable)
library(ggpubr)
library(raster)
'%!in%' <- function(x,y)!('%in%'(x,y))


#quadrant centroid lat/long
quadloc = read.csv("QuadChart.csv", header = TRUE)

# label separate months by name -
monthlabels = c("1" ="Jan","2" = "Feb","3"= "Mar","4" = "Apr","5"= "May","6" ="Jun", "7" = "Jul", "8" = "Aug","9"= "Sep","10" = "Oct","11"= "Nov","12"= "Dec")

```



```{r import data, include = FALSE}

# Read in data:
SRKW = read.csv("Orca Master 2020 - Submission Docs/Appendices & Data/AppendixII_2020.csv", header = TRUE, na.strings=c("", "NA", " ")) # na.strings call sets blank cells to NA
SRKWsummer = SRKW[which(SRKW$Month %in% c("7", "8","9")),]
#Define time range interested in. Here, looking at most recent 15 years. If only want one year, just put one year; for example: year_range = c(2005)
#2019 not complete - but can use for sightings (not occurrence by month)
year_range = c(1990:2020)

#subset data to those years: 
SRKWrecent = SRKW[which(SRKW$Year %in% year_range),]
# Temporary variable to house data 
SRKWareas = SRKWrecent

# make "best" pod column - what pod do we most likely think it is?
SRKWareas$BestPod = rep(NA, length = nrow(SRKWareas))

for(i in 1: nrow(SRKWareas)) {
  if(!is.na(SRKWareas$LikelyPod[i])) {
    SRKWareas$BestPod[i] = SRKWareas$LikelyPod[i]
  } else {
    SRKWareas$BestPod[i] = SRKWareas$Pod[i]
  }
}
#takes sometime to run, ~1 minute

# trouble shooting - make sure the "bestpod" column has an entry for every row

havelikely = which(!is.na(SRKWareas$LikelyPod))
onlypod = which(is.na(SRKWareas$LikelyPod))
identical(SRKWareas$LikelyPod[havelikely], SRKWareas$BestPod[havelikely])
identical(SRKWareas$Pod[onlypod], SRKWareas$BestPod[onlypod]) #should be true

# one sighting with no pod info at all, throw out - have no idea what whales they are (transient, resident, southern vs. northern etc) so can't use or have other sightings for that day
nopod = which(is.na(SRKWareas$BestPod))
SRKWuse = SRKWareas[-nopod,]

#NOW just get SRKW sightings, not transients, NRKW, or non-specified
# DON'T INCLUDE "orcas" FOR ATLANTIS occurrence - less certainty
SRKWspecific = SRKWuse[grepl("J|K|L|SR|SRKW|SWKW", SRKWuse$BestPod, ignore.case = TRUE) == TRUE ,] 

# 84264/ 100480 sightings are specified to SRKWs, J, K,L - 84% of the sightings


others = SRKWuse[grepl("J|K|L|SR|SRKW|SWKW", SRKWuse$BestPod, ignore.case = TRUE) == FALSE ,] #16216 --> +84264 = 100480
unique(others$BestPod) # should be all those that wouldn't indicate Southern Residents
# "Ts"   "Ts?"  "?"    "NRs"  "NRs?" "HB?"
```

*IMPORTANT 
Need to run before all analyses - no matter what number of years you will be looking at. Turns all blanks, nulls, or O's in the data into NA
```{r eval=FALSE, include=FALSE}
length(which(is.na(SRKWspecific$ActLat) & is.na(SRKWspecific$Lat))) #438/ 84264
length(which(is.na(SRKWspecific$ActLat) & is.na(SRKWspecific$Lat) & is.na(SRKWspecific$Quadrant)))
length(which(is.na(SRKWspecific$Quadrant))) #1043

SRKWspecific$Quadrant[which(SRKWspecific$Quadrant == '0')] = NA
SRKWspecific$Quadrant[which(SRKWspecific$Quadrant == '<Null>')] = NA
SRKWspecific$ActLat[which(SRKWspecific$ActLat == 0)] = NA
SRKWspecific$ActLong[which(SRKWspecific$ActLong == 0)] = NA
SRKWspecific$Lat[which(SRKWspecific$Lat == 0)] = NA
SRKWspecific$Long[which(SRKWspecific$Long == 0)] = NA
SRKWspecific$Long[which(SRKWspecific$Long == "<Null>")] = 
SRKWspecific$Lat[which(SRKWspecific$Lat == "<Null>")] = NA

```


Code to run analysis for most recent 10 years 2011-2020, looking at whole year 
Recent 10 years
```{r eval=FALSE, include=TRUE}
SRKwspecificrecent = SRKWspecific[which(SRKWspecific$Year %in% c(2011:2020)),]
SRKW_10years = SRKwspecificrecent[which(!is.na(SRKwspecificrecent$Quadrant)),]

### QUADRANTS ####
# Data with quadrants
SRKW_10years$NewLat = SRKW_10years$ActLat
SRKW_10years$NewLong = SRKW_10years$ActLong

SRKW_10years$Lat = as.numeric(SRKW_10years$Lat)
SRKW_10years$Long = as.numeric(SRKW_10years$Long)

SRKW_10years$Quadrant = as.numeric(SRKW_10years$Quadrant)

SRKW_10years$Long[which(SRKW_10years$Long > 0)] = -SRKW_10years$Long[which(SRKW_10years$Long > 0)]

# Each quadrant was assigned a center lat/long by the whale museum. if a latitude/longitude is missing but there is a quadrant number, pull from data file on quadrant lat/long to get correct lat/long for each quadrant

length(which(!is.na(SRKW_10years$Quadrant) & is.na(SRKW_10years$Lat)))

count = 0
for(i in 1:nrow(SRKW_10years)) {
  if(is.na(SRKW_10years$NewLat[i]) & is.na(SRKW_10years$NewLong[i])) {
    if(!is.na(SRKW_10years$Lat[i]) & !is.na(SRKW_10years$Long[i])) {
      SRKW_10years$NewLat[i] = SRKW_10years$Lat[i]
      SRKW_10years$NewLong[i] = SRKW_10years$Long[i]
    } else if(!is.na(SRKW_10years$Quadrant[i])) {
      count = count + 1
      quadmatch = SRKW_10years$Quadrant[i]
      index = which(quadloc$Quad == quadmatch)
      SRKW_10years$NewLat[i] = quadloc$Lat[index]
      SRKW_10years$NewLong[i] = -quadloc$Long[index]
  }
  }
}
print(count)


SRKW_10years[which(SRKW_10years$NewLat < 42),] 

quadloc[which(quadloc$Quad == 163),]
fix = which(SRKW_10years$NewLat < 42)
SRKW_10years$NewLat[fix] = SRKW_10years$Lat[fix]
SRKW_10years$NewLong[fix] = SRKW_10years$Long[fix]


## All months not just Summer ############

# remove duplicate day quadrant combos before projecting 
SRKW_10years_norepeat = SRKW_10years %>% distinct(Month, Day, Year, Quadrant, .keep_all= TRUE)

whale_simple10 <- SRKW_10years_norepeat %>% 
            st_as_sf(coords = c('NewLong', 'NewLat'))
st_crs(whale_simple10) <- 4326

#whale_simple10new = st_transform(whale_simple10, 32610)

#Atlantis
atlantis <- readOGR("Atlantis_shapefiles", layer = "bgm_Puget_Sound_89b_0p0001_NAD83")
atlantis_sf <- st_as_sf(atlantis)
crs(atlantis_sf)

whale_simple10_atlantis = st_transform(whale_simple10, st_crs(atlantis_sf))

Allsightings = ggplot() +
  geom_sf(data = atlantis_sf) +
   geom_sf(data = whale_simple10_atlantis) 
#print(Allsightings)


# find which atlantis polygons sightings fall into 
whalesin10_atlantis = st_intersection(whale_simple10_atlantis, atlantis_sf)

Allmonthssightingsplot = ggplot() +
   geom_sf(data = whalesin10_atlantis, size = 1) +
  geom_sf(data = atlantis_sf, colour = "red", fill = NA) +
    geom_sf_text(data = atlantis_sf, aes(label = BOX_ID), colour = "blue", size = 3) 
#print(Allmonthssightingsplot)

#just summer
Summerplot = ggplot() +
   geom_sf(data = whalesin10_atlantis[which(whalesin10_atlantis$Month %in% c("7","8","9")),], size = 1) +
  geom_sf(data = atlantis_sf, colour = "red", fill = NA) +
    geom_sf_text(data = atlantis_sf, aes(label = BOX_ID), colour = "blue", size = 4) + ggtitle("Summer months only")
#print(Summerplot)

whalecount_bybox = whalesin10_atlantis %>% count(BOX_ID, Month, sort = TRUE)
ggplot() +
  geom_sf(data = atlantis_sf) +
    geom_sf_text(data = atlantis_sf, aes(label = BOX_ID), colour = "blue", size = 3)

ggplot(data=whalecount_bybox, aes(x=BOX_ID, y=n)) +
  geom_bar(stat="identity") + facet_wrap(~Month)

colourCount = 12
library(RColorBrewer)
getPalette = colorRampPalette(brewer.pal(9, "Set1"))

ggplot(data=whalecount_bybox, aes(x=BOX_ID, y=n, fill = as.factor(Month))) +
 geom_bar(stat="identity") +   scale_fill_manual(values = getPalette(colourCount)) + 
  theme_minimal()

whalecount_sept = whalecount_bybox[which(whalecount_bybox$Month == "9"),]
whalecount_sept$prop = whalecount_sept$n / sum(whalecount_sept$n)


sum(whalecount_bybox$n[which(whalecount_bybox$BOX_ID == 5)]) #2880
summeronly = whalecount_bybox[which(whalecount_bybox$Month %in% c("7", "8", "9")),]
sum(summeronly$n) #5002
sum(summeronly$n[which(summeronly$BOX_ID %in% c(5,16, 18))]) #2812
2812/5002


# export data
write.csv(whalesin10_atlantis,"SRKWsightings_withAtlantisBox.csv", row.names = FALSE)
```


End